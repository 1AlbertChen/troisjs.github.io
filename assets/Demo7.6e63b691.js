import{Y as e,P as t,V as r,W as i,S as n,bk as s,M as o,N as a,b as h,R as l,n as d,x as u,bg as f,bi as m,al as p}from"./OrbitControls.42fcbb91.js";import{t as c}from"./tweakpane.b85ca853.js";import{f as v,n as g,x,r as y,o as D,c as w,w as M,b}from"./app.80aaf375.js";import{A as S,a as C,c as U,d as P,S as q}from"./trois.module.99ddcb6e.js";import{O as F}from"./Object3D.e03d1dd0.js";import{a as H}from"./tools.bf27e82e.js";function E(e){this.renderer=e,this.width=512,this.height=512,this.delta=new r(1/this.width,1/this.height);const t={minFilter:a,magFilter:a,type:h,format:l,depthBuffer:!1};this.hMap=new i(this.width,this.height,t),this.hMap1=new i(this.width,this.height,t),this.fsQuad=new N,this.initShaders()}E.prototype.initShaders=function(){const e="\n    varying vec2 vUv;\n    void main() {\n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n  ";this.copyMat=new n({uniforms:{tDiffuse:{value:null}},vertexShader:e,fragmentShader:"\n      uniform sampler2D tDiffuse;\n      varying vec2 vUv;\n      void main() {\n        gl_FragColor = texture2D(tDiffuse, vUv);\n      }\n    "}),this.updateMat=new n({uniforms:{tDiffuse:{value:null},delta:new s(this.delta)},vertexShader:e,fragmentShader:"\n      uniform sampler2D tDiffuse;\n      uniform vec2 delta;\n      varying vec2 vUv;\n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n\n        vec2 dx = vec2(delta.x, 0.0);\n        vec2 dy = vec2(0.0, delta.y);\n        float average = (\n          texture2D(tDiffuse, vUv - dx).r +\n          texture2D(tDiffuse, vUv - dy).r +\n          texture2D(tDiffuse, vUv + dx).r +\n          texture2D(tDiffuse, vUv + dy).r\n        ) * 0.25;\n        texel.g += (average - texel.r) * 2.0;\n        texel.g *= 0.995;\n        texel.r += texel.g;\n\n        gl_FragColor = texel;\n      }\n    "}),this.normalsMat=new n({uniforms:{tDiffuse:{value:null},delta:new s(this.delta)},vertexShader:e,fragmentShader:"\n      uniform sampler2D tDiffuse;\n      uniform vec2 delta;\n      varying vec2 vUv;\n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        vec3 dx = vec3(delta.x, texture2D(tDiffuse, vec2(vUv.x + delta.x, vUv.y)).r - texel.r, 0.0);\n        vec3 dy = vec3(0.0, texture2D(tDiffuse, vec2(vUv.x, vUv.y + delta.y)).r - texel.r, delta.y);\n        texel.ba = normalize(cross(dy, dx)).xz;\n        gl_FragColor = texel;\n      }\n    "}),this.dropMat=new n({uniforms:{tDiffuse:{value:null},center:new s(new r),radius:{value:.05},strength:{value:.5}},vertexShader:e,fragmentShader:"\n      const float PI = 3.1415926535897932384626433832795;\n      uniform sampler2D tDiffuse;\n      uniform vec2 center;\n      uniform float radius;\n      uniform float strength;\n      varying vec2 vUv;\n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        float drop = max(0.0, 1.0 - length(center * 0.5 + 0.5 - vUv) / radius);\n        drop = 0.5 - cos(drop * PI) * 0.5;\n        texel.r += drop * strength;\n        // texel.r = clamp(texel.r, -2.0, 2.0);\n        gl_FragColor = texel;\n      }\n    "})},E.prototype.update=function(){this.updateHMap(),this.updateHMapNormals()},E.prototype.updateHMap=function(){this.updateMat.uniforms.tDiffuse.value=this.hMap.texture,this.renderShaderMat(this.updateMat,this.hMap1),this.swapBuffers()},E.prototype.updateHMapNormals=function(){this.normalsMat.uniforms.tDiffuse.value=this.hMap.texture,this.renderShaderMat(this.normalsMat,this.hMap1),this.swapBuffers()},E.prototype.addDrop=function(e,t,r,i){this.dropMat.uniforms.tDiffuse.value=this.hMap.texture,this.dropMat.uniforms.center.value.set(e,t),this.dropMat.uniforms.radius.value=r,this.dropMat.uniforms.strength.value=i,this.renderShaderMat(this.dropMat,this.hMap1),this.swapBuffers()},E.prototype.renderShaderMat=function(e,t){this.fsQuad.material=e;const r=this.renderer.getRenderTarget();this.renderer.setRenderTarget(t),this.fsQuad.render(this.renderer),this.renderer.setRenderTarget(r)},E.prototype.swapBuffers=function(){const e=this.hMap;this.hMap=this.hMap1,this.hMap1=e};const N=function(){const r=new e(-1,1,1,-1,0,1),i=new t(2,2),n=function(e){this._mesh=new o(i,e)};return Object.defineProperty(n.prototype,"material",{get:function(){return this._mesh.material},set:function(e){this._mesh.material=e}}),Object.assign(n.prototype,{render:function(e){e.render(this._mesh,r)}}),n}();const _={components:{AmbientLight:S,Camera:C,LiquidPlane:v({extends:F,props:{width:{type:Number,default:10},height:{type:Number,default:10},widthSegments:{type:Number,default:200},heightSegments:{type:Number,default:200},color:{type:[Number,String],default:"#ffffff"},metalness:{type:Number,default:.75},roughness:{type:Number,default:.25}},mounted(){this.liquidEffect=new E(this.three.renderer),this.rendererComponent.onMounted((()=>{this.liquidEffect.renderer=this.rendererComponent.renderer,this.three.onBeforeRender(this.update)})),this.material=new d({color:this.color,side:u,metalness:this.metalness,roughness:this.roughness,onBeforeCompile:e=>{e.uniforms.hmap={value:this.liquidEffect.hMap.texture},e.vertexShader="uniform sampler2D hmap;\n"+e.vertexShader;e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n          vec3 transformed = vec3(position);\n          vec4 info = texture2D(hmap, uv);\n          vNormal = vec3(info.b, sqrt(1.0 - dot(info.ba, info.ba)), info.a).xzy;\n          transformed.z = 20. * info.r;\n        ")}}),H(this,["metalness","roughness"],this.material),g((()=>this.color),(e=>this.material.color.set(e))),this.geometry=new t(this.width,this.height,this.widthSegments,this.heightSegments),this.mesh=new o(this.geometry,this.material),this.initObject3D(this.mesh)},unmounted(){this.three.offBeforeRender(this.update)},methods:{update(){this.liquidEffect.update()}}}),PointLight:U,Renderer:P,Scene:q},setup:()=>({WIDTH:30,HEIGHT:30}),data:()=>({color:"#ffffff",metalness:1,roughness:.2,light1Color:"#FFFF80",light2Color:"#DE3578",light3Color:"#FF4040",light4Color:"#0d25bb"}),mounted(){this.pointer=this.$refs.renderer.three.pointer,this.liquidEffect=this.$refs.liquid.liquidEffect,this.liquidEffect.addDrop(0,0,.05,.05),this.raycaster=new f,this.pointerPlane=new m(new p(0,0,1),0),this.pointerV3=new p,this.pane=new c,this.pane.addInput(this,"color"),this.pane.addInput(this,"metalness",{min:0,max:1}),this.pane.addInput(this,"roughness",{min:0,max:1}),this.pane.addButton({title:"Random lights"}).on("click",this.randomColors)},unmounted(){this.pane.dispose()},methods:{onPointerMove(){this.raycaster.setFromCamera(this.pointer.positionN,this.$refs.renderer.three.camera),this.raycaster.ray.intersectPlane(this.pointerPlane,this.pointerV3);const e=2*this.pointerV3.x/this.WIDTH,t=2*this.pointerV3.y/this.HEIGHT;this.liquidEffect.addDrop(e,t,.025,.005)},randomColors(){this.light1Color=x.random().hex(),this.light2Color=x.random().hex(),this.light3Color=x.random().hex(),this.light4Color=x.random().hex()}}};_.render=function(e,t,r,i,n,s){const o=y("Camera"),a=y("AmbientLight"),h=y("PointLight"),l=y("LiquidPlane"),d=y("Scene"),u=y("Renderer");return D(),w(u,{ref:"renderer",antialias:"",pointer:{onMove:s.onPointerMove},resize:"","orbit-ctrl":{enableDamping:!0}},{default:M((()=>[b(o,{position:{x:0,y:0,z:20}}),b(d,{ref:"scene"},{default:M((()=>[b(a),b(h,{color:n.light1Color,position:{x:50,y:50,z:50}},null,8,["color"]),b(h,{color:n.light2Color,position:{x:-50,y:50,z:50}},null,8,["color"]),b(h,{color:n.light3Color,position:{x:-50,y:-50,z:50}},null,8,["color"]),b(h,{color:n.light4Color,position:{x:50,y:-50,z:50}},null,8,["color"]),b(l,{ref:"liquid",width:i.WIDTH,height:i.HEIGHT,"width-segments":512,"height-segments":512,color:n.color,metalness:n.metalness,roughness:n.roughness},null,8,["width","height","color","metalness","roughness"])])),_:1},512)])),_:1},8,["pointer"])};export default _;
